#!/usr/bin/env bash
set -euo pipefail

FORMATTER=(ruff format)
LINTER=(ruff check --fix)
IMPORT_ORGANIZER=(ruff check --select I --fix)

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "${repo_root}" ]]; then
  echo "Error: not inside a git repository."
  exit 1
fi

cd "${repo_root}"

files=()

while IFS= read -r -d '' f; do
  files+=("$f")
done < <(git diff -z --name-only --diff-filter=d -- '*.py')

while IFS= read -r -d '' f; do
  files+=("$f")
done < <(git diff --cached -z --name-only --diff-filter=d -- '*.py')

if ((${#files[@]} > 0)); then
  mapfile -t unique_files < <(printf '%s\n' "${files[@]}" | sort -u)

  echo "Files to organize imports, lint, and format:"
  printf '%s\n' "${unique_files[@]}"

  "${IMPORT_ORGANIZER[@]}" "${unique_files[@]}"
  "${LINTER[@]}" "${unique_files[@]}"
  "${FORMATTER[@]}" "${unique_files[@]}"
else
  echo "No modified or staged Python files found."
fi

exit 0
